<div class="dashboard-container">
  <!-- Header Section -->
  <div class="dashboard-header mb-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
      <div>
        <h1 class="dashboard-title mb-2">
          <i class="me-2 text-primary"></i>Home
        </h1>
      </div>
    </div>
  </div>

  <!-- Overview Chart Section -->
  <div class="row g-4 mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-0 py-3 px-4">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-bold">
              <i class="bi bi-graph-up me-2 text-primary"></i>ภาพรวม Dashboard
            </h5>
            <button 
              class="btn btn-outline-primary btn-sm"
              (click)="exportChartToPDF()"
              title="ส่งออกเป็น PDF">
              <i class="bi bi-file-earmark-pdf me-2"></i>ส่งออก PDF
            </button>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="chart-container-overview">
            <canvas #overviewChart></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters and Search Section -->
  <div class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body p-4">
      <div class="row g-3">
        <!-- Search -->
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted fw-bold text-uppercase">ค้นหา</label>
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
              <i class="bi bi-search text-muted"></i>
            </span>
            <input 
              type="text" 
              class="form-control border-start-0" 
              placeholder="ค้นหาตามชื่อพื้นที่..."
              [(ngModel)]="searchQuery"
              (input)="onSearchChange()">
            <button 
              class="btn btn-primary" 
              type="button"
              (click)="onSearchChange()"
              title="ค้นหา">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <!-- Rank Filter -->
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted fw-bold text-uppercase">ระดับความเสี่ยง</label>
          <select 
            class="form-select" 
            [(ngModel)]="selectedRank"
            (change)="onRankFilterChange(selectedRank)">
            <option [value]="null">ทั้งหมด</option>
            <option value="A">Rank A (สูง)</option>
            <option value="B">Rank B (ปานกลาง)</option>
            <option value="C">Rank C (ทั่วไป)</option>
          </select>
        </div>

        <!-- Status Filter -->
        <div class="col-12 col-md-3">
          <label class="form-label small text-muted fw-bold text-uppercase">สถานะ</label>
          <select 
            class="form-select" 
            [(ngModel)]="selectedStatus"
            (change)="onStatusFilterChange(selectedStatus)">
            <option [value]="null">ทั้งหมด</option>
            <option value="NotYetDone">ยังไม่ดำเนินการ</option>
            <option value="OnProcess">กำลังดำเนินการ</option>
            <option value="Done">เสร็จสิ้น</option>
          </select>
        </div>

        <!-- Clear Filters -->
        <div class="col-12 col-md-2 d-flex align-items-end">
          <button 
            class="btn btn-outline-secondary w-100" 
            (click)="clearFilters()"
            [disabled]="!searchQuery && !selectedRank && !selectedStatus">
            <i class="bi bi-x-circle me-1"></i>ล้าง
          </button>
        </div>
      </div>
    </div>
  </div>

  <a routerLink="/create" class="btn btn-primary btn-lg shadow-sm px-4">
    <i class="bi bi-plus-circle me-2"></i>แจ้งเรื่องใหม่
  </a>
  <br>
  <hr>
  <!-- Reports Table Card -->
  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="card-header bg-white border-0 py-3 px-4">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold">
          <i class="bi bi-list-ul me-2 text-primary"></i>รายการแจ้งปัญหา
          <span class="badge bg-primary ms-2">{{ filteredReports.length }}</span>
        </h5>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="text-muted mt-3 mb-0">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Mobile View -->
    <div *ngIf="!isLoading" class="d-block d-md-none">
      <div class="list-group list-group-flush">
        <div *ngFor="let item of filteredReports" class="list-group-item border-0 p-4">
          <div class="d-flex align-items-start gap-3">
            <div class="report-image-mobile">
              <div class="ratio ratio-4x3 rounded-3 overflow-hidden bg-light shadow-sm">
                <img *ngIf="item.imageBeforeUrl" 
                     [src]="getImageUrl(item.imageBeforeUrl)" 
                     alt="Before" 
                     class="object-fit-cover">
                <div *ngIf="!item.imageBeforeUrl" 
                     class="d-flex align-items-center justify-content-center text-muted h-100">
                  <i class="bi bi-image fs-4"></i>
                </div>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-1 fw-bold">{{ item.area }}</h6>
                  <p class="text-muted small mb-0 text-truncate" style="max-width: 200px;">
                    {{ item.detail }}
                  </p>
                </div>
                <span class="badge rank-badge" [ngClass]="{
                  'bg-danger': item.rank === 'A',
                  'bg-warning text-dark': item.rank === 'B',
                  'bg-success': item.rank === 'C'
                }">Rank {{ item.rank }}</span>
              </div>
              <div class="d-flex flex-wrap gap-2 mb-2">
                <span class="badge bg-light text-dark border">
                  <i class="bi bi-tag me-1"></i>{{ item.category || '-' }}
                </span>
                <span class="badge status-badge" [ngClass]="{
                  'bg-secondary': item.status === 'NotYetDone',
                  'bg-primary': item.status === 'OnProcess',
                  'bg-success': item.status === 'Done'
                }">
                  {{ getStatusLabel(item.status) }}
                </span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <div class="avatar-sm me-2">
                    {{ getInitials(item.responsiblePerson) }}
                  </div>
                  <small class="text-muted">{{ item.responsiblePerson || '-' }}</small>
                </div>
                <div class="btn-group">
                  <button 
                    class="btn btn-sm btn-outline-info"
                    (click)="viewDetails(item.id!)"
                    title="ดูรายละเอียด">
                    <i class="bi bi-eye"></i>
                  </button>
                  <a [routerLink]="['/edit', item.id]" 
                     class="btn btn-sm btn-outline-primary"
                     title="แก้ไข">
                    <i class="bi bi-pencil"></i>
                  </a>
                  <button class="btn btn-sm btn-outline-danger" 
                          (click)="deleteItem(item.id!)"
                          title="ลบ">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Desktop Table View -->
    <div *ngIf="!isLoading" class="table-responsive d-none d-md-block">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="ps-4" style="width: 5%;">#</th>
            <th style="width: 12%;">รูปภาพ</th>
            <th style="width: 25%;">รายละเอียด / พื้นที่</th>
            <th style="width: 12%;">Category</th>
            <th style="width: 10%;">Rank</th>
            <th style="width: 15%;">ผู้รับผิดชอบ</th>
            <th style="width: 12%;">สถานะ</th>
            <th class="text-end pe-4" style="width: 9%;">จัดการ</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of filteredReports" class="table-row-hover">
            <td class="ps-4">
              <span class="fw-bold text-muted">#{{ item.id }}</span>
            </td>
            <td>
              <div class="report-image">
                <div class="ratio ratio-4x3 rounded-3 overflow-hidden bg-light shadow-sm">
                  <img *ngIf="item.imageBeforeUrl" 
                       [src]="getImageUrl(item.imageBeforeUrl)"
                       class="object-fit-cover" 
                       alt="Before">
                  <div *ngIf="!item.imageBeforeUrl"
                       class="d-flex align-items-center justify-content-center text-muted h-100">
                    <i class="bi bi-image"></i>
                  </div>
                </div>
              </div>
            </td>
            <td>
              <div class="fw-bold text-dark mb-1">{{ item.area }}</div>
              <small class="text-muted d-block text-truncate" style="max-width: 250px;">
                {{ item.detail }}
              </small>
            </td>
            <td>
              <span class="badge bg-light text-dark border px-3 py-2">
                <i class="bi bi-tag me-1"></i>{{ item.category || '-' }}
              </span>
            </td>
            <td>
              <span class="badge rank-badge" [ngClass]="{
                'bg-danger': item.rank === 'A',
                'bg-warning text-dark': item.rank === 'B',
                'bg-success': item.rank === 'C'
              }">
                Rank {{ item.rank }}
              </span>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar me-2">
                  {{ getInitials(item.responsiblePerson) }}
                </div>
                <span class="small">{{ item.responsiblePerson || '-' }}</span>
              </div>
            </td>
            <td>
              <span class="badge status-badge" [ngClass]="{
                'bg-secondary': item.status === 'NotYetDone',
                'bg-primary': item.status === 'OnProcess',
                'bg-success': item.status === 'Done'
              }">
                {{ getStatusLabel(item.status) }}
              </span>
            </td>
            <td class="text-end pe-4">
              <div class="btn-group">
                <button 
                  class="btn btn-sm btn-outline-info" 
                  (click)="viewDetails(item.id!)"
                  title="ดูรายละเอียด">
                  <i class="bi bi-eye"></i>
                </button>
                <a [routerLink]="['/edit', item.id]" 
                   class="btn btn-sm btn-outline-primary" 
                   title="แก้ไข">
                  <i class="bi bi-pencil"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger" 
                        (click)="deleteItem(item.id!)"
                        title="ลบ">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="filteredReports.length === 0 && !isLoading">
            <td colspan="8" class="text-center py-5">
              <div class="empty-state">
                <i class="bi bi-inbox display-1 text-muted opacity-50 mb-3"></i>
                <h5 class="text-muted mb-2">
                  {{ searchQuery || selectedRank || selectedStatus ? 'ไม่พบข้อมูลที่ค้นหา' : 'ยังไม่มีข้อมูลแจ้งซ่อม' }}
                </h5>
                <p class="text-muted mb-3">
                  {{ searchQuery || selectedRank || selectedStatus ? 'ลองเปลี่ยนเงื่อนไขการค้นหาหรือล้างตัวกรอง' : 'เริ่มต้นแจ้งปัญหาความปลอดภัยได้เลย' }}
                </p>
                <a *ngIf="!searchQuery && !selectedRank && !selectedStatus" 
                   routerLink="/create" 
                   class="btn btn-primary">
                  <i class="bi bi-plus-circle me-2"></i>แจ้งเรื่องใหม่
                </a>
                <button *ngIf="searchQuery || selectedRank || selectedStatus" 
                        class="btn btn-outline-secondary"
                        (click)="clearFilters()">
                  <i class="bi bi-x-circle me-2"></i>ล้างตัวกรอง
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
